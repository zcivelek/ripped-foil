---
title: "Ripped Foil - Children"
author: "Zeynep Civelek"
date: "June 10, 2020"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, include=TRUE)

#This sets general options for the code chunks in the R Markdown file. The echo, warning, and message = FALSE hide the code chunks, warning messages, and other messages, where the ‘include=true’ will make all figures appear in the text. You can set some of these variables to TRUE, and hit Knit to see what they change. 
```

```{r}
#PREPARE
R.Version()#for referencing, shows you which R version you are using
rm(list=ls())#removes any other items in your workspace
ls()#check whether workspace is empty
```

```{r}
#Directory is set, data is added and all the libraries necessary for running the analyses are loaded.

#setwd("C:/Users/Zeynep/Desktop/ripped-foil/Ripped Foil")
ripchild<-read.csv("ripped_child.csv", header=T)
#all the libraries necessary to run the analyses
library(lme4)
library(readr)
library(tidyverse)
library(sjPlot)
#install.packages('TMB', type='source')
library(ggthemes)
library(gridExtra)
library(reshape2)
library(car)
#library(psych)
library("ggpubr")
library(dplyr)

```

The structure of the data is shown below with all the variable names and levels of measurement.

```{r}
ripchild$age <- as.factor(ripchild$age)# makes continuous variables categorical
ripchild$id<-as.factor(ripchild$id)
ripchild$sex<-as.factor(ripchild$sex)

str(ripchild)

```

We decided to use age as a continuous variable (age in months) in our main analyses rather than categorical to have more power.The distribution of age:

```{r pressure, echo=FALSE}
hist(ripchild$agemonths, xlab="Age in months (36-72)", ylab="Frequency")

```

I aggregated the trial-by-trial data to create one score per child for Test and Transfer phases so I can check whether they are normally distributed or not.

```{r}
ripchild_individual <- ripchild %>%
  group_by(id, age, agemonths) %>% 
  summarize(correct = mean(correct))%>%
  ungroup()%>%
  group_by(agemonths)%>%
    add_count(correct)

ripchild_test <- ripchild %>%
  filter(order3=="test") %>%
  group_by(id, age, agemonths) %>% 
  summarize(correct = mean(correct))

ripchild_transfer <- ripchild %>%
  filter(order3=="transfer") %>%
  group_by(id,age, agemonths) %>% 
  summarize(correct = mean(correct)) 

```

Histograms for Test and Transfer

```{r}
hist(ripchild_test$correct, xlab="Mean score in Test", xlim=c(0,1))
hist(ripchild_transfer$correct, xlab="Mean score in Transfer", xlim=c(0,1))
hist(ripchild_individual$correct, xlab="Overall score (Test and Transfer)", xlim=c(0,1))
```



```{r}

shapiro.test(ripchild_individual$correct)

shapiro.test(ripchild_test$correct)

shapiro.test(ripchild_transfer$correct)
```

The Shapiro-Wilk normality tests confirm that the data are not normally distributed for Test and Transfer phases (neither for an overall score).

Below is the how children in different ages perform in test and transfer.
```{r}
testBYage<-ggplot(ripchild_test, aes(agemonths, correct))
s1<-testBYage + geom_point(aes(), position="jitter") + labs(x= "Age in months", y= "Mean Performance in Test")+ 
  geom_smooth(method ="lm", alpha=0.2)+
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+scale_y_continuous(limits=c(0,1),oob=scales::rescale_none)

transferBYage<-ggplot(ripchild_transfer, aes(agemonths, correct))
s2<-transferBYage + geom_point(aes(), position="jitter") + labs(x= "Age in months", y= "Mean Performance in Transfer") + 
  geom_smooth(method ="lm", alpha=0.2) +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+scale_y_continuous(limits=c(0,1),oob=scales::rescale_none)

grid.arrange(s1, s2, nrow = 1, heights=unit(100, "mm"))
```

The regression line (with a 95% CI) for the Transfer phase is steeper than the Test phase. Younger children seem to be doing worse in Transfer than in Test.



Next is the pre-processing of data: z-transformations for 'trial no' and 'age in months', coding dummy variables for trialtype, sex and phase (order3), and finally centering the random slope components for these variables.

```{r}
#Preprocessing of data, Z-transforming trial no and age

ripchild$z.trialno<-as.vector(scale(ripchild$trialno))
ripchild$z.age=as.vector(scale(ripchild$agemonths))

ripchild$trialtype<-relevel(ripchild$trialtype, ref = "pen")
summary(ripchild)

```

```{r}
#Coding dummy variables before centering the slopes
ripchild$trialtype.sticker<-as.numeric(ripchild$trialtype==levels(ripchild$trialtype)[2])
ripchild$sex.m<-as.numeric(ripchild$sex==levels(ripchild$sex)[2])
ripchild$order3.transfer<-as.numeric(ripchild$order3==levels(ripchild$order3)[2])

#Centering the slopes
ripchild$trialtype.sticker.c<-ripchild$trialtype.sticker-mean(ripchild$trialtype.sticker)
ripchild$sex.m.c<-ripchild$sex.m -mean(ripchild$sex.m)
ripchild$order3.transfer.c<-ripchild$order3.transfer-mean(ripchild$order3.transfer)
```


```{r}
source("./Roger_functions/diagnostic_fcns.r")
source("./Roger_functions/glmm_stability.r")
source("./Roger_functions/boot_glmm.r")
```



```{r}

# Guide on how to decide on the model...

xx.fe.re=fe.re.tab(fe.model="correct  ~
                  trialtype*order3+trialno+
                   z.age*order3+sex",
                   re="(1|id)",
                   data=data.frame(ripchild))
xx.fe.re$summary
ydata=xx.fe.re$data
```


Full model

```{r}
contr<-glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=10000000))
full<-glmer(correct ~ trialtype*order3+z.trialno+z.age*order3+sex+(1|id)+(0+z.trialno+order3.transfer.c+trialtype.sticker.c|id),data=ripchild, family=binomial, control=contr)

```

The full model does not include box type (the location of the blue/pink box) as a random effect anymore due to convergence issues.

Model assumptions

Distribution of random effects
```{r}
#An assumption of GLMMs is that the BLUPs are normally distributed. We use the following function to evaluate this. BLUPs are Best Linear Unbiased Predictors: the estimated grouping factor's level specific deviation from the common intercept or slope.
ranef.diagn.plot(full2)
```

Model stability

```{r}
#summary reveals min and max of the estimates obtained after casewise deletion of levels of random effects together with the original estimates.
m.stab=glmm.model.stab(model.res=full, contr=contr)
m.stab.plot(m.stab$summary[,-1])
m.stab$summary
m.stab$detailed$warnings
```

Multicollinearity

```{r}
coll=lm(correct ~ trialtype*order3+z.trialno+order3*z.age+sex, data=ripchild)
round(vif(coll),3)
#no vif issues
```

Overdispersion

```{r}
#overdispersion test
overdisp.test(full)
```

Null model

```{r}
null<-glmer(correct~ 1+(1|id)+(0+z.trialno+order3.transfer.c+trialtype.sticker.c|id),data=ripchild, family=binomial, control=contr)

```

Full and Null comparison
```{r}
round(anova(null, full, test="Chisq"),3)

```

Model output

Coefficients

```{r}
round(summary(full)$coefficients, 3)

```

Individual predictor: Likelihood tests

```{r}
xdrop1=drop1(full, test="Chisq",control=contr)
round(xdrop1,3)
```

Confidence intervals for the full model with the interaction

```{r}
#boot.res=boot.glmm.pred(model.res=full, excl.warnings=T, nboots=1000, para=T)
# round(boot.res$ci.estimates, 3)
# save.image("model1_CIs.RData")
# boot.res.int$ci.estimates
# boot.res.int$ci.predicted
load("model1_CIs.RData")
```


The interactions terms are not significant (although there is a trend for scores to vary by age) so I will remove them from the model.

Reduced model without the interactions
Full model 2

```{r}
full2=glmer(correct ~ trialtype+order3+z.trialno+z.age+sex+(1|id)+(0+z.trialno+order3.transfer.c+trialtype.sticker.c|id),data=ripchild, family=binomial, control=contr)
summary(full2)
```

Null model

```{r}
null<-glmer(correct~ 1+(1|id)+(0+z.trialno+order3.transfer.c+trialtype.sticker.c|id),data=ripchild, family=binomial, control=contr)

```

Full 2 and null comparision

```{r}
round(anova(null, full2, test="Chisq"),3)

```

####Model output
  +Coefficients

```{r echo=FALSE}
round(summary(full2)$coefficients, 3)

```

  + Individual predictors : Likelihod ratio tests
  
  
```{r echo=FALSE}
xdrop1=drop1(full2, test="Chisq",control=contr)
round(xdrop1,3)
```

Age emerges as a significant predictor of scores.

```{r}
# this is for me to check the variance added by random effects, number of observations and subjects etc.
print(summary(full2), corr=FALSE)
```

Confidence intervals for the reduced model without the interaction

```{r}
model2CI=boot.glmm.pred(model.res=full2, excl.warnings=T, nboots=1000, para=T)
round(model2CI$ci.estimates, 3)
save.image("model2_CIs.RData")
load("model2_CIs.RData")
```

 Running a separate model for the CI calculation. Age is entered as age in months (notz transformed).

```{r}
#running a new model for CI predictions
full.CI=glmer(correct ~ z.trialno+order3.transfer.c+trialtype.sticker.c+z.age+sex.m.c+(1+z.trialno+order3.transfer.c+trialtype.sticker.c|id),data=ripchild, family=binomial, control=contr)

```

Getting confidence intervals for fitted values

```{r}
#boot.res=boot.glmm.pred(model.res=full.CI, excl.warnings=T, nboots=1000, resol=68, level=0.95, use="z.age", n.cores="all-1", para=T)#with para=T your computer will get very slow so I recommend using this option particularly when you don't need to work with the PC in parallel (the CI calculation will be a lot faster though)

#boot.res$ci.estimates
#boot.res$ci.predicted
save.image("ripped_foil_child_CIs.RData")
```

For the geom_point plot - go over this before running.

```{r}
#there are 68 different data points (agemonths) and the argument resol of the function boot.glmm.pred was set to this value
#create sequence with agemonths against which lines should be plotted:


ripchild_individual2 <- ripchild %>%
  group_by(id,  z.age) %>% 
  summarize(correct= mean(correct))%>%
  ungroup()%>%
  group_by(z.age)%>%
    add_count(correct)

plot.xvals=seq(from=min(ripchild_individual$agemonths), to=max(ripchild_individual$agemonths),
length.out=68)

##using ggplot but using the values from ripchild_individual instead)

scatter<-ggplot(ripchild_individual, aes(x=plot.xvals, y=boot.res$ci.predicted$fitted)) + geom_point(aes(x=agemonths, y=correct), size=ripchild_individual$n, alpha=0.8)+
geom_ribbon(data=boot.res$ci.predicted, aes(x=plot.xvals,ymin=boot.res$ci.predicted$lower.cl,ymax=boot.res$ci.predicted$upper.cl), fill="grey", alpha=0.5)+
geom_line(data=boot.res$ci.predicted, aes(x = plot.xvals,y=boot.res$ci.predicted$fitted), lty=2)+
theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ xlab("Age in months")+ ylab("Mean correct responses")+ 
  ylim(0,1)+
  geom_hline(yintercept=0.50, color='red', linetype="dashed")

scatter

```


```{r}
# From Eva - need to put these top three lines, otherwise get an error msg.
par(mar=c(3, 3, 0.2, 0.2), mgp=c(1.7, 0.3, 0), las=1, tcl=-0.15)
plot(x=ripchild_individual$agemonths, y=ripchild_individual$correct, pch=19, las=2, ylim=c(0, 1),
xlab="Age in months", ylab="Mean correct responses")

plot.xvals=seq(from=min(ripchild_individual$agemonths), to=max(ripchild_individual$agemonths),length.out=68)

lines(x=plot.xvals, y=boot.res$ci.predicted$fitted,
lty=2)
lines(x=plot.xvals, y=boot.res$ci.predicted$lower.cl,
lty=3)
lines(x=plot.xvals, y=boot.res$ci.predicted$upper.cl,
lty=3)
abline(h = 0.5, col="red", lwd=3, lty=2)
```

Running a new model for calculating CIs for the interaction model

```{r}
full.CI.int<-glmer(correct ~ trialtype.sticker.c+z.age*order3+sex.m.c+z.trialno+(1|id)+(0+z.trialno+order3.transfer.c+trialtype.sticker.c|id),data=ripchild, family=binomial, control=contr)

```

Getting the CIs for the interaction model

```{r}


#boot.res.int=boot.glmm.pred(model.res=full.CI.int, excl.warnings=T, nboots=1000, resol=136, level=0.95, use="z.age", n.cores="all-1", para=T) #resol=136 this time because data is aggregated for test and transfer separately.
#boot.res.int$ci.estimates
#boot.res.int$ci.predicted

#save.image("ripped_foil_child_CIs_interaction.RData")
load("ripped_foil_child_CIs_interaction.RData")
```



```{r}
ripchild_separate <- ripchild %>%
  group_by(id,  z.age, order3) %>% 
  summarize(correct= mean(correct))%>%
  ungroup()%>%
  group_by(z.age, order3)%>%
    add_count(correct)

plot.int=seq(from=min(ripchild_separate$agemonths), to=max(ripchild_separate$agemonths),
length.out=136)

scatter.int<-ggplot(ripchild_separate, aes(x=boot.res.int$ci.predicted$z.age, y=boot.res.int$ci.predicted$fitted)) +
 geom_point(aes(x=z.age, y=correct), size=ripchild_separate$n, alpha=0.8) +    facet_wrap(~order3)+
geom_ribbon(data=boot.res.int$ci.predicted, aes(y=boot.res.int$ci.predicted$fitted, ymin=boot.res.int$ci.predicted$lower.cl, ymax=boot.res.int$ci.predicted$upper.cl), fill="grey", alpha=0.5)+geom_line(data=boot.res.int$ci.predicted, aes(y=boot.res.int$ci.predicted$fitted), lty=2)+
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ xlab("Age in months")+ ylab("Mean correct responses")+ 
  ylim(0,1)+
  geom_hline(yintercept=0.50, color='red', linetype="dashed")
  
  scatter.int
  

```


```{r}

#do the same scatter plot for interaction with age not z-tranformed so the graph is more informative.
ripchild_separate2 <- ripchild %>%
  group_by(id,  agemonths, order3) %>% 
  summarize(correct= mean(correct))%>%
  ungroup()%>%
  group_by(agemonths, order3)%>%
    add_count(correct)

plot.int=seq(from=min(ripchild_separate2$agemonths), to=max(ripchild_separate2$agemonths),
length.out=272)

scatter.int2<-ggplot(ripchild_separate2, aes(x=plot.int, y=boot.res.int$ci.predicted$fitted, group=order3)) +
 geom_point(aes(x=agemonths, y=correct), size=ripchild_separate2$n, alpha=0.8) +    facet_wrap(~order3) + geom_ribbon(data=boot.res.int$ci.predicted, aes(x=plot.int, y=boot.res.int$ci.predicted$fitted, ymin=boot.res.int$ci.predicted$lower.cl, ymax=boot.res.int$ci.predicted$upper.cl, group=boot.res.int$ci.predicted$order3),fill="grey", alpha=0.5) + geom_line(data=boot.res.int$ci.predicted, aes(y=boot.res.int$ci.predicted$fitted), lty=2)+
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ xlab("Age in months")+ ylab("Mean correct responses")+ 
  ylim(0,1)+
  geom_hline(yintercept=0.50, color='red', linetype="dashed")
  
  scatter.int2
```


Getting the data for the first trial of Transfer

```{r}
ripchild_1st_trial <- ripchild %>%
  filter(order3=="transfer" & trialno=="1") %>%
  group_by(id, age, agemonths, sex, trialtype, z.age, trialtype.sticker.c) %>% 
  summarize(correct)
```

Trial 1 success in Transfer

```{r}
firsttrial <- glm(correct~agemonths+sex+trialtype,data=ripchild_1st_trial,family=binomial(link = "logit"))
summary(firsttrial)

```
Age is a significant predictor of first trial performance of Transfer.


```{r}
#how about ggplot
ggplot(ripchild_1st_trial, aes(x=agemonths, y=correct)) + geom_point() + 
  stat_smooth(method="glm", fullrange = TRUE, lty=2, size=0.5, colour="Black", alpha=0.2,  method.args=list(family="binomial"))+ylab("First trial performance of Transfer Phase")+xlab("Age in months")+xlim(36,72)+theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())
```
























