---
title: "Ripped Foil - Monkeys"
author: "Zeynep Civelek"
date: "June 30, 2020"
output: word_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, include=TRUE)

#This sets general options for the code chunks in the R Markdown file. The echo, warning, and message = FALSE hide the code chunks, warning messages, and other messages, where the ‘include=true’ will make all figures appear in the text. You can set some of these variables to TRUE, and hit Knit to see what they change. 
```

```{r, include=FALSE}
#PREPARE
R.Version()#for referencing, shows you which R version you are using
rm(list=ls())#removes any other items in your workspace
ls()#check whether workspace is empty
```

```{r, include=FALSE}
#Directory is set, data is added and all the libraries necessary for running the analyses are loaded.

ripmon1<-read.csv("ripped_monkey_test16.csv", header=T)
# setwd("C:/Users/Zeynep/Desktop/ripped-foil/Ripped Foil")
# ripchild<-read.csv("ripped_child.csv", header=T)
#all the libraries necessary to run the analyses
library(lme4)
library(readr)
library(tidyverse)
library(sjPlot)
#install.packages('TMB', type='source')
library(ggthemes)
library(gridExtra)
library(reshape2)
library(car)
#library(psych)
library("ggpubr")
library(dplyr)

```
##Exploring data 

The structure of the data is shown below with all the variable names and levels of measurement.

```{r, echo=FALSE}
ripmon1$id<-as.factor(ripmon1$id)
ripmon1$sex<-as.factor(ripmon1$sex)
ripmon1$phase2<-as.factor(ripmon1$phase2)

str(ripmon1)

```

Exploring the warm-up 1 (locating the reward when there is no foil covering the cups) and warm-up 2 phases (locating the reward when the cups are covered with foil).
```{r, echo=FALSE}
ripmon_complete<-read.csv("ripped_monkey_complete.csv", header=T)
ripmon_warm1 <- ripmon_complete %>%
  filter(sessiontype=="warmup") %>%
  group_by(id, sex, age, sessionno, trialno) %>% 
  summarize(correct)

ripmon_warm2 <- ripmon_complete %>%
  filter(sessiontype=="foil") %>%
  group_by(id, sex, age, sessionno, trialno) %>% 
  summarize(correct)

range(ripmon_warm1$sessionno)
range(ripmon_warm2$sessionno)
```
**In warm-up 1, monkeys got up to 18 sessions to reach criterion and in warm-up 2, up to 6 sessions (or they'd receive up to 10 sessions). The minimum number of sessions to reach criterion was 2 (14/16 correct)**

##Histograms for Warm-up 1 and Warm-up 2 Phases
```{r, echo=FALSE}
agg_warm1 <- aggregate(ripmon_warm1$correct, by = list(id = ripmon_warm1$id), function(x) c(mean = mean(x), sd = sd(x), n = length(x)))
agg_warm1 <- do.call(data.frame, agg_warm1)
agg_warm1$se <- agg_warm1$x.sd / sqrt(agg_warm1$x.n)

colnames(agg_warm1) <- c("id", "mean", "sd", "n", "se")

agg_warm1$names <- c(paste(agg_warm1$id, "id"))

limits <- aes(ymax = agg_warm1$mean + agg_warm1$se,
              ymin = agg_warm1$mean - agg_warm1$se)

hist(agg_warm1$mean, xlab="Mean score in Warm-up 1", xlim=c(0,1))

agg_warm2 <- aggregate(ripmon_warm2$correct, by = list(id = ripmon_warm2$id), function(x) c(mean = mean(x), sd = sd(x), n = length(x)))
agg_warm2 <- do.call(data.frame, agg_warm2)
agg_warm2$se <- agg_warm2$x.sd / sqrt(agg_warm2$x.n)

colnames(agg_warm2) <- c("id", "mean", "sd", "n", "se")

agg_warm2$names <- c(paste(agg_warm2$id, "id"))

limits <- aes(ymax = agg_warm2$mean + agg_warm2$se,
              ymin = agg_warm2$mean - agg_warm2$se)

hist(agg_warm2$mean, xlab="Mean score in Warm-up 2", xlim=c(0,1))

```

I then aggregated the trial-by-trial data to create one score per monkey for Test and Transfer phases so I can check the distribution of scores.

```{r, echo=FALSE}
ripmon_individual <- ripmon1 %>%
  filter(!is.na(correct)) %>%
  group_by(id) %>% 
  summarize(correct = mean(correct))%>%
  add_count(correct)

ripmon_test <- ripmon1 %>%
   filter(!is.na(correct)) %>%
  filter(phase=="test") %>%
  group_by(id) %>% 
  summarize(correct = mean(correct))%>%
  add_count(correct)

ripmon_transfer <- ripmon1 %>%
   filter(!is.na(correct)) %>%
  filter(phase=="transfer") %>%
  group_by(id) %>% 
  summarize(correct = mean(correct))%>%
  add_count(correct)

ripmon_separate <- ripmon1 %>%
   filter(!is.na(correct)) %>%
  group_by(id, phase,age) %>% 
  summarize(correct = mean(correct))%>%
  add_count(correct)

```

##Histograms for Test and Transfer Phases and the overall score

```{r}
hist(ripmon_test$correct, xlab="Mean score in Test", xlim=c(0,1))
hist(ripmon_transfer$correct, xlab="Mean score in Transfer", xlim=c(0,1))
hist(ripmon_individual$correct, xlab="Overall score (Test and Transfer)", xlim=c(0,1))
```
##Below is how performance looks in the last 16 trials of Test and Transfer

```{r, echo=FALSE}
boxplot1 <- ggplot(ripmon_separate, aes(x=phase, y=correct)) + 
    geom_dotplot(binaxis='y', stackdir='center', dotsize=0.5) + ylim(0,1)
boxplot1 + stat_summary(fun.data="mean_sdl", fun.args = list(mult=1), geom="crossbar", width=0.5) + stat_summary(fun.y=mean, geom="point", color="red")+theme_bw() + stat_summary(fun.data=mean_sdl, fun.args = list(mult=1), 
                 geom="pointrange", color="red")+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+geom_hline(yintercept=0.50, color='red', linetype="dashed")+xlab("Phase") + ylab("Mean number of correct responses in 16 trials")
```

##Preparation of the data for running the GLMM

* Scaling age and trial number
* Coding categorical variables as dummy variables 
* Centering the slopes.

```{r, echo=FALSE}
#We scale variables so that the differences in the range of the variables do not influence the parameter estimations.
ripmon1$z.trialno<-as.vector(scale(ripmon1$trialno))
ripmon1$z.age=as.vector(scale(ripmon1$age))
ripmon1$trialtype<-relevel(ripmon1$trialtype, ref = "stick")

#coding dummy variables before centering the slopes
ripmon1$trialtype.food<-as.numeric(ripmon1$trialtype==levels(ripmon1$trialtype)[2])
ripmon1$sex.m<-as.numeric(ripmon1$sex==levels(ripmon1$sex)[2])
ripmon1$phase.transfer=as.numeric(ripmon1$phase==levels(ripmon1$phase)[2])

#centering the slopes: p-values of the factors can be influenced by the choice of reference category.
#by centering the factor for the random slope components the p-values should be the same irrespective of the choice of the reference level
ripmon1$trialtype.food.c<-ripmon1$trialtype.food-mean(ripmon1$trialtype.food)
ripmon1$phase.transfer.c=ripmon1$phase.transfer-mean(ripmon1$phase.transfer)
ripmon1$sex.m.c<-ripmon1$sex.m -mean(ripmon1$sex.m)

```

```{r, echo=FALSE}
source("./Roger_functions/diagnostic_fcns.r")
source("./Roger_functions/glmm_stability.r")
source("./Roger_functions/boot_glmm.r")
```

```{r, include=FALSE}

# Guide on how to decide on the model...

xx.fe.re=fe.re.tab(fe.model="correct  ~
                  trialtype*phase+trialno+
                   z.age+sex",
                   re="(1|id)",
                   data=data.frame(ripmon1))
xx.fe.re$summary
ydata=xx.fe.re$data
```

##Full model 

```{r, echo=TRUE}
contr<-glmerControl(optimizer="bobyqa", optCtrl=list(maxfun=10000000))
full=glmer(correct ~ trialtype*phase+z.trialno+z.age+sex+(1|id)+(0+z.trialno+phase.transfer.c+trialtype.food.c|id),data=ripmon1, family=binomial, control=contr)
```

The full model does not include box type (the location of the blue/pink box) as a random effect anymore due to convergence issues. The correlations between random slope and random intercept are not included either.

##Model assumptions

####Distribution of random effects
```{r, echo=FALSE}
#An assumption of GLMMs is that the BLUPs are normally distributed. We use the following function to evaluate this. BLUPs are Best Linear Unbiased Predictors: the estimated grouping factor's level specific deviation from the common intercept or slope.
ranef.diagn.plot(full)
```

####Model stability

```{r, echo=FALSE}
#summary reveals min and max of the estimates obtained after casewise deletion of levels of random effects together with the original estimates.
m.stab=glmm.model.stab(model.res=full, contr=contr)
m.stab.plot(m.stab$summary[,-1])
m.stab$summary
m.stab$detailed$warnings
```

####Multicollinearity

```{r, echo=FALSE}
coll=lm(correct ~ trialtype+phase+z.trialno+z.age+sex, data=ripmon1)
round(vif(coll),3)
#no vif issues
```

##Null model

```{r, echo=TRUE}
null=glmer(correct~z.trialno+(1|id)+(0+z.trialno+phase.transfer.c+trialtype.food.c|id),data=ripmon1, family=binomial, control=contr)
```
**Added trial no to the null model to control for its effects.**

##Full and Null comparison
```{r, echo=FALSE}
round(anova(null, full, test="Chisq"),3)
```
**The full model is significantly different than the null model.**

##Model output

####Coefficients

```{r, echo=FALSE}
round(summary(full)$coefficients, 3)
```

####Individual predictor: Likelihood tests

```{r, echo=FALSE}
xdrop1=drop1(full, test="Chisq",control=contr)
round(xdrop1,3)
```
**There is a significant effect of sex. The interaction term is not significant.**

####Confidence intervals for the full model with the interaction

```{r, echo=FALSE}
ripmon_model1=boot.glmm.pred(model.res=full, excl.warnings=T, nboots=1000, para=T)
save.image("ripmon_model1_CIs.RData")
load("ripmon_model1_CIs.RData")
round(ripmon_model1$ci.estimates, 3)

```

**I will remove the non-significant interaction term to reduce the model.**

##Reduced model without the interaction
##Full model 2

```{r, echo=TRUE}
full2=glmer(correct ~ trialtype+phase+z.trialno+z.age+sex+(1|id)+(0+z.trialno+phase.transfer.c+trialtype.food.c|id),data=ripmon1, family=binomial, control=contr)
summary(full2)
```

I get the following warning: convergence code: 0, boundary (singular) fit: see ?isSingular.

**The model summary show that there is a significant effect of sex and trial type.**

##Null model 2

```{r, echo=TRUE}
null2<-glmer(correct~ z.trialno + (1|id)+(0+z.trialno+phase.transfer.c+trialtype.food.c|id),data=ripmon1, family=binomial, control=contr)
```

##Full and null model (2) comparion

```{r, echo=FALSE}
round(anova(null2, full2, test="Chisq"),3)
```
**There is a significant difference between the full and the null model.**

##Model output

####Coefficients

```{r, echo=FALSE}
round(summary(full2)$coefficients, 3)

```

####Individual predictors : Likelihood ratio tests
  
```{r echo=FALSE}
xdrop1=drop1(full2, test="Chisq",control=contr)
round(xdrop1,3)
```
**The trial type and sex are significant predictors of performance.**

```{r, include=FALSE}
# this is for me to check the variance added by random effects, number of observations and subjects etc.
print(summary(full2), corr=FALSE)
```

####Confidence intervals for the reduced model without the interaction

```{r, echo=FALSE}
ripmon_model2=boot.glmm.pred(model.res=full2, excl.warnings=T, nboots=1000, para=T)
save.image("ripmon_model2_CIs.RData")
load("ripmon_model2_CIs.RData")
round(ripmon_model2$ci.estimates, 3)
```

####Calculating effect sizes for the final model

```{r, echo=FALSE}
#install.packages("MuMIn")
library("MuMIn")
r.squaredGLMM(object=full2)

#the (marginal and conditional) effect sizes in the row headed delta are the ones according to a recent paper (Nakagawa et al., 2017) which you should report. Marginal R-squared is the variance explained by the fixed effects. The conditional R-squared is the variance explained by the fixed and random effects (the model)
```
Here we look at the row headed delta. Marginal R-squared is the variance explained by the fixed effects and the conditional R-squared is the variance explained by the fixed and random effects (the model).


##Plotting the findings
```{r, echo=FALSE}
ripmon_individual2<-ripmon1 %>% 
  group_by(phase, id) %>% 
  summarize(foil.correct = mean(correct)) %>% 
  add_count(foil.correct)

p1 <- ggplot(data=ripmon_individual2, aes(x=phase, y=foil.correct, group=phase)) + geom_boxplot()+geom_point(size = ripmon_individual2$n, colour = "darkgrey", alpha=0.3) + geom_line(aes(group = id), colour = "darkgrey", alpha = 0.5)+labs(x="",y="Mean number of correct choices")+theme_few()+ggtitle("Phase")+geom_hline(yintercept=0.5, linetype="dashed", color = "red")+ylim(0,1)

ripmon_individual3 <- ripmon1 %>% 
  group_by(trialtype, id) %>% 
  summarize(foil.correct = mean(correct)) %>% 
  add_count(foil.correct)

p2 <- ggplot(data=ripmon_individual3, aes(x=trialtype, y=foil.correct, group=trialtype)) +geom_boxplot()+geom_line(aes(group = id), colour = "darkgrey", alpha = 0.5)+geom_point(size = ripmon_individual3$n, colour = "darkgrey", alpha=0.3) +geom_line(lty=2)+labs(x="",y="Mean number of correct choices")+ theme_few()+ggtitle("Trial type")+geom_hline(yintercept=0.5, linetype="dashed", color = "red")+ylim(0,1)

ripmon_individual4<-ripmon1 %>% 
  group_by(sex, id) %>% 
  summarize(foil.correct = mean(correct)) %>% 
  add_count(foil.correct)

p3 <- ggplot(data=ripmon_individual4, aes(x=sex, y=foil.correct, group=sex)) + geom_boxplot()+ylim(0,1)+ geom_point(size = ripmon_individual4$n, colour = "darkgrey", alpha=0.3) +labs(x="",y="Mean number of correct choices")+theme_few()+ggtitle("Sex")+geom_hline(yintercept=0.5, linetype="dashed", color = "red")

grid.arrange(p1, p2, p3, nrow = 1, heights=unit(100, "mm"))
```


```{r, include=FALSE}
#Doing a bar graph

ripaggregate <- aggregate(ripmon1$correct, by = list(order = ripmon1$order, phase = ripmon1$phase), function(x) c(mean = mean(x), sd = sd(x), n = length(x)))
ripaggregate <- do.call(data.frame, ripaggregate)
ripaggregate$se <- ripaggregate$x.sd / sqrt(ripaggregate$x.n)

colnames(ripaggregate) <- c("order", "phase", "mean", "sd", "n", "se")

ripaggregate$names <- c(paste(ripaggregate$order, "order",
                              ripaggregate$phase, "phase"))

limits <- aes(ymax = ripaggregate$mean + ripaggregate$se,
              ymin = ripaggregate$mean - ripaggregate$se)
p <- ggplot(data = ripaggregate, aes(x = factor(order), y = mean, fill = factor(phase)))
p + geom_bar(stat = "identity", position = position_dodge(0.9), width = 0.8) + geom_errorbar(limits, position = position_dodge(0.9), width = 0.10) + labs(x= "", y = "Mean correct responses") + ggtitle("Performance in test and transfer phases by trial type") + scale_fill_grey(name = "Phase") + geom_hline(yintercept=0.50, linetype="dashed", color="red", size=1)  + theme(legend.text = element_text(size = 8)) + ylim(0.00,1.00) + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),panel.background = element_blank())

```

##Test against chance
####Test and transfer phase

```{r, echo=TRUE}
testphase <-ripmon1%>%
  filter(phase == "test")
testchance <- glmer(correct ~ 1 + (z.trialno | id),data= testphase, family=binomial)
summary(testchance)
```

**The intercept is significant: Performance in Test phase is above chance level.**

```{r, echo=TRUE}
transferphase <-ripmon1%>%
  filter(phase == "transfer")
transferchance <- glmer(correct ~ 1 + (z.trialno | id),data= transferphase, family=binomial)
summary(transferchance)
```

**Performanc in Transfer phase is above chance level as well. And there is no significant difference between the monkeys' performances in Test and Transfer phases.**

####Trial type

```{r, echo=FALSE}
sticktrials <-ripmon1%>%
  filter(trialtype == "stick")
stickchance <- glmer(correct ~ 1 + (z.trialno | id),data= sticktrials, family=binomial)
summary(stickchance)
```


```{r echo=FALSE}
foodtrials <-ripmon1%>%
  filter(trialtype == "food")
foodchance <- glmer(correct ~ 1 + (z.trialno | id),data= foodtrials, family=binomial)
summary(foodchance)
```
**There is a significant difference between performances in different trial types: monkeys performed better in food-stick trials than stick-food trials. Their performance was above chance in both.**

##First trial performance in Transfer phase

```{r, include=FALSE}
ripmon_1st_trial <- ripmon1 %>%
  filter(phase=="transfer" & sessionno=="1", trialno=="1")
```

####Performance in Trial 1 of Transfer
```{r, echo=TRUE}
#I am fitting a glm with binomial error structure for the first trial transfer phase analysis and not a mixed model given that it only includes one data point per subject.
firsttrial <- glm(correct~z.age+sex+trialtype,data=ripmon_1st_trial,family=binomial(link = "logit"))
summary(firsttrial)
```


####Is the performance above chance in first trial of Transfer?
 
```{r,echo=FALSE}
firsttrial_trans<-t.test(ripmon_1st_trial$correct, mu=0.5, alternative = "two.sided")
firsttrial_trans
```
**No, performance in the first trial of transfer does not differ from chance level.


##How about the first 8 trials of Test phase (to be able to compare to children)?

```{r, echo=FALSE}
ripmon_test8 <- ripmon_complete %>%
  filter(sessiontype=="test" & sessionno=="1") %>%
  group_by(id, sex, sessiontype, trialtype, trialno, phase) %>% 
  summarize(correct)
```

##Performance against chance in the first 8 trials of the test phase:

```{r, echo=FALSE}
ttest8<-t.test(ripmon_test8$correct, mu=0.5, alternative = "two.sided")
ttest8
```
**They are at chance level in the first 8 trials of Test (for comparison purposes with children).**



